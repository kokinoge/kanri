# 📊 CSV エクスポート機能 - フェーズ1実装完了

## 🎯 **実装概要**

CSVエクスポート機能のフェーズ1として、強化されたCSV出力機能を実装しました。データテーブルページから様々な形式でCSVファイルを出力できるようになりました。

## ✅ **実装済み機能**

### **1. 基本CSV出力**
- **場所**: データテーブルページ (`/data-tables`)
- **ボタン**: 「CSV出力」
- **機能**: 現在表示中のデータをCSV形式で出力

### **2. 高度CSV出力**
- **場所**: データテーブルページ
- **ボタン**: 「高度CSV出力」
- **機能**: 詳細オプション設定付きCSV出力

### **3. CSV API エンドポイント**
- **URL**: `/api/csv-export`
- **メソッド**: GET
- **機能**: プログラマティックCSVデータ取得

## 🔧 **使用方法**

### **基本CSV出力**
1. データテーブルページにアクセス
2. 「実績」「クライアント」「案件」タブを選択
3. 「CSV出力」ボタンをクリック
4. 現在表示中のデータがCSVでダウンロード

### **高度CSV出力**
1. 「高度CSV出力」ボタンをクリック
2. オプションダイアログで設定を調整：
   - **日付形式**: `2025年01月` / `25/01` / `2025-01-01`
   - **数値形式**: `1,000,000` / `¥1,000,000` / `1000000`
   - **文字エンコーディング**: `UTF-8` / `Shift_JIS`
   - **区切り文字**: カンマ / セミコロン / タブ
3. エクスポートデータタイプを選択：
   - 実績データ
   - 予算データ
   - クライアント
   - 案件データ
   - **全データ統合**

## 📋 **CSV出力フォーマット**

### **実績データ**
```csv
年月,クライアント名,案件名,プラットフォーム,運用タイプ,支出,実績,ROAS,作成日時
2025年1月,テスト株式会社,テスト案件,Instagram,インハウス運用,"¥500,000","¥600,000",1.20,2025-01-15
```

### **クライアントデータ**
```csv
クライアント名,担当者,事業部,優先度,案件数,作成日,営業部門
テスト株式会社,佐藤葉月,SNSメディア事業部,高,3,2025/1/15,国内営業部
```

### **案件データ**
```csv
案件名,クライアント名,目的,開始日,終了日,総予算,事業部
テスト案件,テスト株式会社,ブランド認知,2025/1/1,2025/12/31,"¥5,000,000",SNSメディア事業部
```

### **全データ統合**
```csv
年月,クライアント名,案件名,プラットフォーム,運用タイプ,予算金額,支出,実績,ROAS,予算タイプ,事業部
2025年1月,テスト株式会社,テスト案件,Instagram,インハウス運用,"¥500,000","¥500,000","¥600,000",1.20,投稿予算,SNSメディア事業部
```

## 🌐 **API仕様**

### **エンドポイント**
```
GET /api/csv-export
```

### **パラメータ**

#### **フィルターパラメータ**
- `year`: 年 (例: `2024`)
- `month`: 月 (例: `12`)
- `clientId`: クライアントID
- `platform`: プラットフォーム (例: `Instagram`)
- `operationType`: 運用タイプ (例: `インハウス運用`)
- `department`: 事業部 (例: `SNSメディア事業部`)

#### **CSV形式パラメータ**
- `type`: データタイプ (`results` / `clients` / `campaigns` / `budgets` / `all`)
- `dateFormat`: 日付形式 (`YYYY年MM月` / `YY/MM` / `YYYY-MM-DD`)
- `numberFormat`: 数値形式 (`formatted` / `currency` / `raw`)
- `encoding`: エンコーディング (`utf-8` / `shift_jis`)
- `delimiter`: 区切り文字 (`,` / `;` / `\t`)

### **使用例**

#### **基本使用**
```bash
curl "http://localhost:3000/api/csv-export?type=results"
```

#### **フィルター付き**
```bash
curl "http://localhost:3000/api/csv-export?type=all&year=2024&month=12&platform=Instagram"
```

#### **カスタム形式**
```bash
curl "http://localhost:3000/api/csv-export?type=clients&dateFormat=YY/MM&numberFormat=currency&encoding=shift_jis"
```

## 📈 **フィルター連動機能**

データテーブルページで設定されたフィルター条件が自動的に適用されます：

- ✅ **年フィルター**: 指定年のデータのみ
- ✅ **月フィルター**: 指定月のデータのみ
- ✅ **クライアントフィルター**: 指定クライアントのみ
- ✅ **プラットフォームフィルター**: 指定プラットフォームのみ
- ✅ **運用タイプフィルター**: 指定運用タイプのみ
- ✅ **事業部フィルター**: 指定事業部のみ

## 🔍 **テスト方法**

### **1. 手動テスト**
1. `http://localhost:3000/data-tables` にアクセス
2. フィルターを設定
3. 「高度CSV出力」から各種データタイプを試す

### **2. APIテスト**
1. `test-csv-export.html` をブラウザで開く
2. 各種テストボタンをクリック
3. API レスポンスとCSV内容を確認

### **3. コマンドラインテスト**
```bash
# 全データ取得
curl -o test-all.csv "http://localhost:3000/api/csv-export?type=all"

# 実績データ（通貨形式）
curl -o test-results.csv "http://localhost:3000/api/csv-export?type=results&numberFormat=currency"

# クライアントデータ（Shift_JIS）
curl -o test-clients.csv "http://localhost:3000/api/csv-export?type=clients&encoding=shift_jis"
```

## 📊 **パフォーマンス**

### **処理時間（目安）**
- **実績データ**: ~100件 → 1-2秒
- **クライアントデータ**: ~50件 → <1秒
- **全データ統合**: ~200件 → 2-5秒

### **ファイルサイズ（目安）**
- **UTF-8**: 標準サイズ
- **Shift_JIS**: +BOM、Excelで直接開ける
- **タブ区切り**: 約20%小さいファイル

## 🛠️ **技術詳細**

### **使用ライブラリ**
- **Papa Parse**: CSV生成・パース
- **Prisma**: データベース操作
- **Next.js**: API エンドポイント

### **データ変換処理**
```typescript
// Prisma Decimal型 → 数値変換
const parseNumber = (value: any): number => {
  if (value && typeof value.toNumber === 'function') {
    return value.toNumber();
  }
  return parseFloat(value) || 0;
};

// CSV形式生成
const csvContent = Papa.unparse(data, {
  header: true,
  delimiter: ',',
  encoding: 'utf-8'
});
```

### **ファイルダウンロード**
```typescript
const blob = new Blob([csvContent], { 
  type: 'text/csv;charset=utf-8' 
});
const url = window.URL.createObjectURL(blob);
// ダウンロード実行
```

## 🔄 **次のフェーズ予定**

### **フェーズ2: CSVインポート機能**
- CSVファイルからのデータインポート
- バリデーション機能
- プレビュー機能

### **フェーズ3: 統合UI改善**
- インポート・エクスポート統合ダイアログ
- テンプレートダウンロード
- バッチ処理機能

## 💡 **使用時の注意点**

### **文字エンコーディング**
- **UTF-8**: 多くのアプリで推奨
- **Shift_JIS**: Excel で日本語を正しく表示

### **区切り文字**
- **カンマ**: 標準的、最も汎用性が高い
- **セミコロン**: ヨーロッパ系Excelで使用
- **タブ**: データにカンマが含まれる場合に推奨

### **数値形式**
- **formatted**: `1,000,000` - 人間が読みやすい
- **currency**: `¥1,000,000` - 通貨表示
- **raw**: `1000000` - システム間連携用

## 🎉 **フェーズ1完了**

✅ **完了項目:**
- CSV ユーティリティライブラリ作成
- CSV API エンドポイント実装
- データテーブルページUI統合
- 複数データタイプ対応
- フィルター連動機能
- 詳細オプション設定
- 文字エンコーディング対応
- テスト環境構築

CSVエクスポート機能のフェーズ1が完了しました！これでデータの柔軟な出力が可能になりました。 